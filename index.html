<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Простой чат</title>
  <style>
    :root { --bg:#0f1720; --panel:#0b1320; --accent:#0ea5a4; --muted:#94a3b8; --text:#e6eef6; }
    body { margin:0; font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,#071022, #0b1220); color:var(--text); display:flex; height:100vh; align-items:center; justify-content:center; }
    .app { width: min(880px, 96vw); height: 88vh; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03); border-radius:12px; display:flex; overflow:hidden; box-shadow: 0 6px 30px rgba(0,0,0,0.6); }
    .sidebar { width:260px; padding:18px; border-right:1px solid rgba(255,255,255,0.02); box-sizing:border-box; background: rgba(255,255,255,0.01); }
    .main { flex:1; display:flex; flex-direction:column; }
    h1 { margin:0 0 8px 0; font-size:18px; color:var(--accent); }
    .muted { color:var(--muted); font-size:13px; margin-bottom:12px; }
    .chat { padding:12px; flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .msg { max-width:70%; padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.02); color:var(--text); font-size:14px; box-shadow: 0 1px 0 rgba(255,255,255,0.01) inset; }
    .msg.me { margin-left:auto; background: linear-gradient(90deg, rgba(14,165,164,0.14), rgba(14,165,164,0.08)); border:1px solid rgba(14,165,164,0.12); }
    .msg .meta { font-size:12px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; }
    .inputbar { padding:12px; display:flex; gap:8px; border-top:1px solid rgba(255,255,255,0.02); }
    .inputbar input[type="text"] { flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); outline:none; }
    .btn { background:var(--accent); color:#042a2a; border:none; padding:9px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .small { font-size:13px; color:var(--muted); }
    .nameRow { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .nameRow input { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }
    .typing { font-size:13px; color:var(--muted); height:18px; margin-left:12px; }
    .sys { text-align:center; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <div class="app" role="application">
    <div class="sidebar">
      <h1>Простой чат</h1>
      <div class="muted">Небольшой недо-мессенджер на Socket.IO</div>
      <div class="nameRow">
        <input id="nameInput" placeholder="Ваше имя (например: Ivan)" maxlength="32" />
        <button id="joinBtn" class="btn">Войти</button>
      </div>
      <div class="small">Подключено: <span id="status">–</span></div>
      <div style="height:12px;"></div>
      <div class="small">Локальные сообщения хранятся в памяти сервера (сбросятся при рестарте)</div>
    </div>

    <div class="main">
      <div class="chat" id="chat"></div>

      <div style="display:flex; align-items:center; gap:12px; padding:8px 12px;">
        <div class="typing" id="typingIndicator"></div>
      </div>

      <div class="inputbar">
        <input id="messageInput" type="text" placeholder="Введите сообщение..." />
        <button id="sendBtn" class="btn">Отправить</button>
      </div>
    </div>
  </div>

  <!-- socket.io client from CDN -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Простой клиент
    const socket = io(); // подключение к тому же хосту
    const chatEl = document.getElementById("chat");
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");
    const sendBtn = document.getElementById("sendBtn");
    const messageInput = document.getElementById("messageInput");
    const status = document.getElementById("status");
    const typingIndicator = document.getElementById("typingIndicator");

    let myName = null;
    let typingTimer = null;

    function addMessage(msg, opts = {}) {
      // msg: { id, user, text, time, meta? }
      const wrap = document.createElement("div");
      if (msg.meta && msg.meta.system) {
        wrap.className = "sys";
        wrap.textContent = `${new Date(msg.time).toLocaleTimeString()} — ${msg.text}`;
      } else {
        wrap.className = "msg" + ((msg.user === myName) ? " me" : "");
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<strong>${escapeHtml(msg.user)}</strong> • <span style="opacity:0.8;">${new Date(msg.time).toLocaleTimeString()}</span>`;
        const txt = document.createElement("div");
        txt.className = "txt";
        txt.textContent = msg.text;
        wrap.appendChild(meta);
        wrap.appendChild(txt);
      }
      chatEl.appendChild(wrap);
      // scroll to bottom
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    // socket events
    socket.on("connect", () => {
      status.textContent = "online";
    });
    socket.on("disconnect", () => {
      status.textContent = "offline";
    });

    socket.on("history", (msgs) => {
      // clear
      chatEl.innerHTML = "";
      msgs.forEach(m => addMessage(m));
    });

    socket.on("message", (msg) => {
      addMessage(msg);
    });

    socket.on("typing", ({ user, typing }) => {
      if (typing) {
        typingIndicator.textContent = `${user} печатает...`;
      } else {
        typingIndicator.textContent = "";
      }
    });

    // join
    joinBtn.addEventListener("click", () => {
      const v = (nameInput.value || "").trim();
      if (!v) {
        alert("Введите имя");
        return;
      }
      myName = v.slice(0,32);
      socket.emit("join", { user: myName });
      nameInput.disabled = true;
      joinBtn.disabled = true;
      messageInput.focus();
    });

    // send
    function sendMessage() {
      if (!myName) {
        alert("Сначала введите имя и нажмите Войти");
        return;
      }
      const txt = (messageInput.value || "").trim();
      if (!txt) return;
      socket.emit("message", { text: txt });
      messageInput.value = "";
      socket.emit("typing", false);
    }
    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      } else {
        // отправляем индикатор печати (throttle)
        socket.emit("typing", true);
        if (typingTimer) clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          socket.emit("typing", false);
        }, 900);
      }
    });

    // автоподключение в режиме dev: если есть имя в query
    (function autoJoinFromQuery(){
      const params = new URLSearchParams(location.search);
      const n = params.get("name");
      if (n) {
        nameInput.value = n;
        joinBtn.click();
      }
    })();
  </script>
</body>
</html>
